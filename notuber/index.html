<!DOCTYPE html>
<html>
    <head>
        <title>Simple Map</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">

        <style>
          /* Always set the map height explicitly to define the size of the div
           * element that contains the map. */
            #map {
                height: 100%;
            }
          /* Optional: Makes the sample page fill the window. */
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
        </style>
     </head>
    <body>
    	
        <div id="map"></div>
        <div id="location"></div>
    	<div id="list"></div>

        <script>
	        var username = "ZUgb1RBuV8";
	      	var and = "&";
	      	var mylat;
	      	var mylng;
	      	var mypos;
	      	var request = new XMLHttpRequest();
	      	var map;

	        function getLocation() {
	        	navigator.geolocation.getCurrentPosition(function(somePos) {
	        		mylat = somePos.coords.latitude;
					mylng = somePos.coords.longitude;
					mypos = new google.maps.LatLng(mylat, mylng);
					initMap();
					addMyInfo();
					addData();
				});
	        }

	        function initMap() {
	            map = new google.maps.Map(document.getElementById('map'), {
	            center: mypos,
	            zoom: 17
	            });
	        }

	        function addMyInfo() {
	        	var myMarker = new google.maps.Marker({
					position: mypos,
					map: map,
					animation: google.maps.Animation.DROP,
					title: "JanetKinsey",
					icon: {url: 'me.jpg', scaledSize: new google.maps.Size(20, 20)}
				});

	        }

	        function addData() {
	            console.log("Start of getData");
	            request.open('POST', "https://jordan-marsh.herokuapp.com/rides", true);
	            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

	            request.onreadystatechange = function() {
	                if (request.readyState == 4 && request.status == 200) {
		                outputDiv = document.getElementById("list");

		                vresponse = request.responseText;       

		                vdata = JSON.parse(vresponse);
		                vdata_length = vdata['vehicles'].length;

		                var count;
		                var marker;
		                var infowindow;
		                var distance;

		                for (count = 0; count < vdata_length; count++) {
		                	marker = new google.maps.Marker({
       								 position: {lat: vdata['vehicles'][count].lat, lng: vdata['vehicles'][count].lng},
       								 map: map,
       								 icon: 'car.png'
       								 });

		                    infowindow = new google.maps.InfoWindow();

		                    google.maps.event.addListener(marker, 'click', (function(marker, count) {
        						return function() {
        							distance = google.maps.geometry.spherical.computeDistanceBetween(marker.position, mypos)/1609.344;
          							infowindow.setContent('<div>' + 'Username: ' + vdata['vehicles'][count].username + '<br>' +
                										  'Miles Away: ' + distance.toString() + '</div>');
          							infowindow.open(map, marker);
       							}
      							})(marker, count));
		                }

		            	
	         		}
	      		};

	      		stringStart = "username="
	      		sendString = stringStart.concat(username, and, "lat=", mylat.toString(), and, "lng=", mylng.toString());
	      		console.log(sendString);
	      		request.send(sendString);
	      	}
	      
    	</script>

    	<script src="https://maps.googleapis.com/maps/api/js?libraries=geometry&callback=getLocation"
    	async defer></script>
   
  	</body>
</html>